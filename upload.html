<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Sketch - P5.js Workshop</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body style="background-color: #000000;">    
  <div id="gallery-container">
      <div id="sketch-container">
        <div class="empty-state">
          <h2>No sketches yet</h2>
          <p>Be the first to <a href="upload.html">upload a sketch</a>!</p>
        </div>
      </div>
      <div class="controls-overlay">
        <div class="nav-buttons">
          <button id="prev-btn" onclick="previousSketch()" disabled="">←</button>
          <button id="next-btn" onclick="nextSketch()" disabled="">→</button>
        </div>
        <div class="sketch-info">
          <span id="sketch-counter"></span>
          <span id="sketch-author"></span>
        </div>
        <div>
          <a href="upload.html" style="color: white; text-decoration: none">
            <button>Upload</button>
            <button onclick="window.location.href='index.html'">Home</button>
          </a>
        </div>
      </div>
    </div>

    <script>
      let sketches = [];
      let currentIndex = 0;

      // Load manifest and initialize gallery
      async function loadGallery() {
        try {
          const response = await fetch('sketches/manifest.json', {
            cache: 'no-cache',
          });
          const data = await response.json();
          sketches = data.sketches || [];

          if (sketches.length === 0) {
            showEmptyState();
          } else {
            loadSketch(0);
          }
        } catch (error) {
          console.error('Error loading manifest:', error);
          showEmptyState();
        }
      }

      // Show empty state when no sketches
      function showEmptyState() {
        const container = document.getElementById('sketch-container');
        container.innerHTML = `
        <div class="empty-state">
          <h2>No sketches yet</h2>
          <p>Be the first to <a href="upload.html">upload a sketch</a>!</p>
        </div>
      `;
        document.getElementById('prev-btn').disabled = true;
        document.getElementById('next-btn').disabled = true;
        document.getElementById('sketch-counter').textContent = '';
        document.getElementById('sketch-author').textContent = '';
      }

      // Load a specific sketch by index
      function loadSketch(index) {
        if (index < 0 || index >= sketches.length) return;

        currentIndex = index;
        const sketch = sketches[index];
        const container = document.getElementById('sketch-container');

        // Create iframe pointing to the sketch viewer
        container.innerHTML = `<iframe 
          src="sketch-viewer.html?sketch=${encodeURIComponent(sketch.filename)}" 
          style="width: 100%; height: 100%; border: none;"
          sandbox="allow-scripts"
        ></iframe>`;

        // Update UI
        updateControls();
      }

      // Update control buttons and info
      function updateControls() {
        const sketch = sketches[currentIndex];

        // Update counter
        document.getElementById('sketch-counter').textContent = `Sketch ${currentIndex + 1} of ${sketches.length}`;

        // Update author
        document.getElementById('sketch-author').textContent = `by ${sketch.author}`;

        // Update button states
        document.getElementById('prev-btn').disabled = currentIndex === 0;
        document.getElementById('next-btn').disabled = currentIndex === sketches.length - 1;
      }

      // Navigation functions
      function previousSketch() {
        if (currentIndex > 0) {
          loadSketch(currentIndex - 1);
        }
      }

      function nextSketch() {
        if (currentIndex < sketches.length - 1) {
          loadSketch(currentIndex + 1);
        }
      }

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
          previousSketch();
        } else if (e.key === 'ArrowRight') {
          nextSketch();
        }
      });

      // Initialize on load
      loadGallery();
    </script>
  

</body>
    <div class="upload-container">
      <h1>Upload Your P5.js Sketch</h1>

      <form id="upload-form">
        <div class="form-group">
          <label for="author-name">Your Name *</label>
          <input
            type="text"
            id="author-name"
            name="authorName"
            required
            maxlength="100"
            placeholder="Enter your name"
          />
        </div>

        <div class="form-group">
          <label>Sketch File (.js) *</label>
          <div id="drop-zone" class="drop-zone">
            <p id="drop-text">Drag & drop your .js file here<br />or click to select</p>
            <input type="file" id="file-input" accept=".js" style="display: none" />
          </div>
        </div>

        <button type="submit" id="upload-btn" disabled>Upload Sketch</button>
        <span class="loading" id="loading" style="display: none">Uploading...</span>
      </form>

      <div id="message"></div>

      <div style="margin-top: 20px">
        <a href="gallery.html">← Back to Gallery</a>
      </div>
    </div>

    <script>
      const WORKER_URL = 'https://p5-upload-worker.michele-muffin.workers.dev';

      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('file-input');
      const dropText = document.getElementById('drop-text');
      const uploadBtn = document.getElementById('upload-btn');
      const uploadForm = document.getElementById('upload-form');
      const messageDiv = document.getElementById('message');
      const loadingSpan = document.getElementById('loading');

      let selectedFile = null;

      // Click to select file
      dropZone.addEventListener('click', () => {
        fileInput.click();
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        handleFile(file);
      });

      // Drag and drop handlers
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('active');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('active');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');

        const file = e.dataTransfer.files[0];
        handleFile(file);
      });

      // Handle file selection
      function handleFile(file) {
        selectedFile = null;
        uploadBtn.disabled = true;

        if (!file) {
          showMessage('Please select a file', 'error');
          return;
        }

        // Validate file type
        if (!file.name.endsWith('.js')) {
          showMessage('File must be a .js file', 'error');
          return;
        }

        // Validate file size (50KB = 51200 bytes)
        if (file.size > 51200) {
          showMessage('File must be less than 50KB', 'error');
          return;
        }

        // File is valid
        selectedFile = file;
        dropText.innerHTML = `<strong>Selected:</strong> ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
        uploadBtn.disabled = false;
        messageDiv.innerHTML = '';
      }

      // Form submission
      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const authorName = document.getElementById('author-name').value.trim();

        if (!authorName) {
          showMessage('Please enter your name', 'error');
          return;
        }

        if (!selectedFile) {
          showMessage('Please select a file', 'error');
          return;
        }

        // Show loading state
        uploadBtn.disabled = true;
        loadingSpan.style.display = 'inline-block';
        messageDiv.innerHTML = '';

        try {
          // Create form data
          const formData = new FormData();
          formData.append('authorName', authorName);
          formData.append('file', selectedFile);

          // Upload to worker
          const response = await fetch(WORKER_URL, {
            method: 'POST',
            body: formData,
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showMessage(
              `Success! Your sketch has been uploaded. <a href="${result.galleryUrl}">View Gallery</a>`,
              'success',
            );
            // Reset form
            uploadForm.reset();
            selectedFile = null;
            dropText.innerHTML = 'Drag & drop your .js file here<br>or click to select';
          } else {
            showMessage(result.error || 'Upload failed', 'error');
            uploadBtn.disabled = false;
          }
        } catch (error) {
          console.error('Upload error:', error);
          showMessage('Upload failed. Please try again.', 'error');
          uploadBtn.disabled = false;
        } finally {
          loadingSpan.style.display = 'none';
        }
      });

      // Show message
      function showMessage(text, type) {
        messageDiv.innerHTML = text;
        messageDiv.className = `message ${type}`;
      }
    </script>
  </body>
</html>
